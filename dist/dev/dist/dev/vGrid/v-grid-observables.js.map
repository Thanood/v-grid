{"version":3,"sources":["vGrid/v-grid-observables.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;kCAMa,gB;AAGX,kCAAY,KAAZ,EAAmB,aAAnB,EAAkC;AAAA;;AAChC,eAAK,aAAL,GAAqB,aAArB;AACA,eAAK,KAAL,GAAa,KAAb;AACA,eAAK,uBAAL,GAA+B,EAA/B;AACA,eAAK,sBAAL,GAA8B,IAA9B;AACA,eAAK,kBAAL,GAA0B,EAA1B;AACD;;mCAMD,2B,0CAA8B;AAAA;;AAE5B,cAAI,yBAAyB,SAAzB,sBAAyB,CAAC,CAAD,EAAI,CAAJ,EAAU;AAGrC,kBAAK,uBAAL;;AAIA,kBAAK,KAAL,CAAW,uBAAX,GAAqC,MAAK,KAAL,CAAW,eAAX,CAA2B,KAA3B,CAAiC,CAAjC,CAArC;AACA,kBAAK,KAAL,CAAW,SAAX;;AAIA,kBAAK,KAAL,CAAW,eAAX,GAA6B,CAAC,CAA9B;;AAEA,kBAAK,KAAL,CAAW,SAAX,CAAqB,KAArB;AACA,gBAAG,CAAC,MAAK,KAAL,CAAW,WAAX,CAAuB,4BAA3B,EAAwD;AAEtD,oBAAK,KAAL,CAAW,SAAX,CAAqB,KAArB;AACA,oBAAK,KAAL,CAAW,cAAX,CAA0B,gCAA1B;;AAEA,oBAAK,KAAL,CAAW,cAAX,CAA0B,KAA1B;AACA,oBAAK,KAAL,CAAW,WAAX,CAAuB,4BAAvB,GAAsD,KAAtD;AACD;AACD,kBAAK,KAAL,CAAW,cAAX,CAA0B,gBAA1B;;AAGA,kBAAK,KAAL,CAAW,qBAAX,GAAmC,IAAnC;AACA,iBAAK,IAAI,CAAT,IAAc,MAAK,KAAL,CAAW,kBAAzB,EAA6C;AAC3C,kBAAI,MAAK,KAAL,CAAW,kBAAX,CAA8B,cAA9B,CAA6C,CAA7C,CAAJ,EAAqD;AACnD,sBAAK,KAAL,CAAW,kBAAX,CAA8B,CAA9B,IAAmC,SAAnC;AACD;AACF;;AAID,kBAAK,sBAAL;AAID,WAvCD;AAwCA,eAAK,KAAL,CAAW,aAAX,CAAyB,eAAzB,CAAyC,SAAzC,CAAmD,KAAK,KAAxD,EAA8D,sBAA9D;AACA,eAAK,kBAAL,GAA0B,sBAA1B;;AAEA,eAAK,sBAAL,GAA8B,KAAK,KAAL,CAAW,aAAX,CAAyB,eAAvD;AAED,S;;mCAMD,sB,qCAAyB;AAAA;;AAEvB,cAAI,gBAAgB,KAAK,aAAL,CAAmB,kBAAnB,CAAsC,KAAK,KAAL,CAAW,eAAjD,EAAkE,SAAlE,CAA4E,UAAC,oBAAD,EAA0B;;AAExH,gBAAI,cAAc,OAAK,KAAL,CAAW,uBAA7B;AACA,gBAAI,MAAM,OAAK,KAAL,CAAW,eAArB;AACA,gBAAI,OAAO,OAAK,KAAL,CAAW,cAAtB;;AAGA,gBAAI,SAAS,CAAC,CAAd;AACA,gBAAI,OAAK,KAAL,CAAW,qBAAf,EAAsC;AACpC,uBAAS,OAAK,KAAL,CAAW,qBAAX,CAAiC,OAAK,KAAL,CAAW,WAA5C,CAAT;AACD;AACD,gBAAI,iBAAiB,IAArB;;AAGA,gBAAI,qBAAqB,MAArB,GAA8B,CAAlC,EAAqC;;AAEnC,kBAAI,QAAQ,KAAZ;AACA,kBAAI,WAAW,EAAf;;AAGA,mCAAqB,OAArB,CAA6B,UAAC,cAAD,EAAmB;AAG9C,oBAAI,eAAe,UAAf,GAA4B,CAAhC,EAAmC;AACjC,uBAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,eAAe,UAAnC,EAA+C,GAA/C,EAAoD;AAClD,gCAAY,IAAZ,CAAiB,IAAI,eAAe,KAAf,GAAuB,CAA3B,CAAjB;AACA,2BAAK,KAAL,CAAW,QAAX,CAAoB,IAAI,eAAe,KAAf,GAAuB,CAA3B,CAApB;AACD;AACF;;AAGD,oBAAI,eAAe,OAAf,CAAuB,MAAvB,GAAgC,CAApC,EAAuC;AAErC,iCAAe,OAAf,CAAuB,OAAvB,CAA+B,UAAC,CAAD,EAAO;AACpC,wBAAI,EAAE,OAAK,KAAL,CAAW,WAAb,MAA8B,MAAlC,EAA0C;AACxC,uCAAiB,KAAjB;AACD;;AAED,wBAAI,cAAc,CAAC,CAAnB;AACA,gCAAY,OAAZ,CAAoB,UAAC,GAAD,EAAM,KAAN,EAAgB;AAClC,0BAAI,IAAI,OAAK,KAAL,CAAW,WAAf,MAAgC,EAAE,OAAK,KAAL,CAAW,WAAb,CAApC,EAA+D;AAC7D,sCAAc,KAAd;AACD;AACF,qBAJD;AAKA,wBAAI,gBAAgB,CAAC,CAArB,EAAwB;AACtB,kCAAY,MAAZ,CAAmB,WAAnB,EAAgC,CAAhC;AACD;AACF,mBAdD;AAeD;AACF,eA7BD;;AAgCA,kBAAI,WAAW,CAAC,CAAhB;;AAGA,kBAAI,CAAC,cAAL,EAAqB;AAGnB,qBAAK,IAAI,CAAT,IAAc,OAAK,KAAL,CAAW,kBAAzB,EAA6C;AAC3C,sBAAI,OAAK,KAAL,CAAW,kBAAX,CAA8B,cAA9B,CAA6C,CAA7C,CAAJ,EAAqD;AACnD,2BAAK,KAAL,CAAW,kBAAX,CAA8B,CAA9B,IAAmC,SAAnC;AACD;AACF;AACD,uBAAK,KAAL,CAAW,qBAAX,GAAmC,IAAnC;AACA,uBAAK,KAAL,CAAW,eAAX,GAA6B,CAAC,CAA9B;AAED,eAXD,MAWO;AAGL,oBAAI,WAAW,CAAC,CAAhB,EAAmB;AACjB,yBAAK,KAAL,CAAW,uBAAX,CAAmC,OAAnC,CAA2C,UAAC,CAAD,EAAI,KAAJ,EAAc;AACvD,wBAAI,WAAW,EAAE,OAAK,KAAL,CAAW,WAAb,CAAf,EAA0C;AACxC,6BAAK,KAAL,CAAW,eAAX,GAA6B,KAA7B;AACD;AACF,mBAJD;AAKD;AAEF;AAID,mBAAK,gBAAL,CAAsB,KAAtB;AAGD;AAGF,WAvFmB,CAApB;AAwFA,eAAK,kBAAL,GAA0B,aAA1B;AACD,S;;mCAMD,2B,0CAA8B;AAAA;;AAC5B,eAAK,KAAL,CAAW,WAAX,CAAuB,mBAAvB,CAA2C,OAA3C,CAAmD,UAAC,QAAD,EAAc;AAC/D,gBAAI,mBAAmB,OAAK,aAAL,CAAmB,gBAAnB,CAAoC,OAAK,KAAL,CAAW,kBAA/C,EAAmE,QAAnE,EAA6E,SAA7E,CAAuF,UAAC,QAAD,EAAW,QAAX,EAAwB;AAGpI,kBAAI,gBAAiB,aAAa,SAAb,IAA0B,aAAa,IAAxC,GAAgD,SAAS,QAAT,EAAhD,GAAsE,QAA1F;AACA,kBAAI,gBAAiB,aAAa,SAAb,IAA0B,aAAa,IAAxC,GAAgD,SAAS,QAAT,EAAhD,GAAsE,QAA1F;;AAEA,kBAAI,kBAAkB,aAAlB,IAAmC,OAAK,KAAL,CAAW,qBAAlD,EAAyE;AACnE,uBAAK,KAAL,CAAW,qBAAX,CAAiC,QAAjC,IAA6C,QAA7C;AACA,uBAAK,KAAL,CAAW,cAAX,CAA0B,eAA1B,CAA0C,OAAK,KAAL,CAAW,eAArD;AACL;AACF,aAVsB,CAAvB;AAWA,mBAAK,uBAAL,CAA6B,IAA7B,CAAkC,gBAAlC;AACD,WAbD;AAcD,S;;mCAMD,4B,2CAA+B;AAC7B,eAAK,sBAAL,CAA4B,WAA5B,CAAwC,KAAK,KAA7C,EAAoD,KAAK,kBAAzD;AAED,S;;mCAMD,uB,sCAA0B;AACxB,eAAK,kBAAL,CAAwB,OAAxB;AACA,eAAK,kBAAL,GAA0B,IAA1B;AACD,S;;mCAMD,4B,2CAA+B;AAC7B,eAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,KAAK,uBAAL,CAA6B,MAAjD,EAAyD,GAAzD,EAA8D;AAC5D,gBAAI;AACF,mBAAK,uBAAL,CAA6B,CAA7B,EAAgC,OAAhC;AACD,aAFD,CAEE,OAAO,CAAP,EAAU,CACX;AACF;AACD,eAAK,uBAAL,GAA+B,EAA/B;AACD,S","file":"vGrid/v-grid-observables.js","sourceRoot":"/source/","sourcesContent":["/*****************************************************************************************************************\n *    VGridObservables\n *    Observers the vGridCollection/current entity for changes\n *    Created by vegar ringdal\n *\n ****************************************************************************************************************/\nexport class VGridObservables {\n\n\n  constructor(vGrid, bindingEngine) {\n    this.bindingEngine = bindingEngine;\n    this.vGrid = vGrid;\n    this.subscriptionsAttributes = []; //here I keep subscriptions to observer on attributes\n    this.collectionSubscription = null; //here I keep subscriptions to observer on collection\n    this.subscriptionsArray = []; //my property subscriptions\n  }\n\n\n  /***************************************************************************************\n   * observer vGridCollection, when entire vGridCollection gets replaced\n   ***************************************************************************************/\n  enableObservablesCollection() {\n\n    let collectionSubscription = (x, y) => {\n\n      //disable array observer\n      this.disableObservablesArray();\n\n      //clone array\n      //key will be set in both collection and internal since with slice we get a refrence\n      this.vGrid.vGridCollectionFiltered = this.vGrid.vGridCollection.slice(0);\n      this.vGrid.checkKeys();\n\n\n      //reset filter/and collection/selection. (should I have option to check is they want to set something?)\n      this.vGrid.vGridCurrentRow = -1;\n\n      this.vGrid.vGridSort.reset();\n      if(!this.vGrid.vGridConfig.keepFilterOnCollectionChange){\n        //clear sort icons //todo improve with event\n        this.vGrid.vGridSort.reset();\n        this.vGrid.vGridGenerator.rebuildGridHeaderHtmlAndViewSlot();\n\n        this.vGrid.vGridSelection.reset();\n        this.vGrid.vGridConfig.keepFilterOnCollectionChange = false;\n      }\n      this.vGrid.vGridGenerator.collectionChange();\n\n      //reset\n      this.vGrid.vGridCurrentEntityRef = null;\n      for (var k in this.vGrid.vGridCurrentEntity) {\n        if (this.vGrid.vGridCurrentEntity.hasOwnProperty(k)) {\n          this.vGrid.vGridCurrentEntity[k] = undefined;\n        }\n      }\n\n\n      //set array observer\n      this.enableObservablesArray();\n\n\n\n    };\n    this.vGrid.__observers__.vGridCollection.subscribe(this.vGrid,collectionSubscription);\n    this.collectioncallable = collectionSubscription;\n\n    this.collectionSubscription = this.vGrid.__observers__.vGridCollection;\n\n  }\n\n\n  /***************************************************************************************\n   * enable attributes observables, like vGridCollection.push/pop/slice, etc etc\n   ***************************************************************************************/\n  enableObservablesArray() {\n\n    let arrayObserver = this.bindingEngine.collectionObserver(this.vGrid.vGridCollection).subscribe((arrayObserverChanges) => {\n\n      var colFiltered = this.vGrid.vGridCollectionFiltered;\n      var col = this.vGrid.vGridCollection;\n      var grid = this.vGrid.vGridGenerator;\n\n\n      var curKey = -1;\n      if (this.vGrid.vGridCurrentEntityRef) {\n        curKey = this.vGrid.vGridCurrentEntityRef[this.vGrid.vGridRowKey];\n      }\n      var curEntityValid = true;\n\n\n      if (arrayObserverChanges.length > 0) {\n\n        var added = false;\n        var toRemove = [];\n\n        //loop arrayObserverChanges\n        arrayObserverChanges.forEach((observerChange)=> {\n\n          //if anyone is added, then lets add them\n          if (observerChange.addedCount > 0) {\n            for (var i = 0; i < observerChange.addedCount; i++) {\n              colFiltered.push(col[observerChange.index + i]);\n              this.vGrid.checkKey(col[observerChange.index + i]);\n            }\n          }\n\n          //if anyone is removed, then lets remove them from our filtered collection\n          if (observerChange.removed.length > 0) {\n            //push into removed array\n            observerChange.removed.forEach((x) => {\n              if (x[this.vGrid.vGridRowKey] === curKey) {\n                curEntityValid = false;\n              }\n\n              var rowToRemove = -1;\n              colFiltered.forEach((row, index) => {\n                if (row[this.vGrid.vGridRowKey] === x[this.vGrid.vGridRowKey]) {\n                  rowToRemove = index;\n                }\n              });\n              if (rowToRemove !== -1) {\n                colFiltered.splice(rowToRemove, 1);\n              }\n            });\n          }\n        });\n\n\n        var newRowNo = -1;\n\n        //check current entity, remove if removed, or get key/row\n        if (!curEntityValid) {\n\n          //no current entity, lets remove the result and null out ref/row\n          for (var k in this.vGrid.vGridCurrentEntity) {\n            if (this.vGrid.vGridCurrentEntity.hasOwnProperty(k)) {\n              this.vGrid.vGridCurrentEntity[k] = undefined;\n            }\n          }\n          this.vGrid.vGridCurrentEntityRef = null;\n          this.vGrid.vGridCurrentRow = -1;\n\n        } else {\n\n          //if there is a current entity, then we need to find the row of the key\n          if (curKey !== -1) {\n            this.vGrid.vGridCollectionFiltered.forEach((x, index) => {\n              if (curKey === x[this.vGrid.vGridRowKey]) {\n                this.vGrid.vGridCurrentRow = index;\n              }\n            });\n          }\n\n        }//end if (!curEntityValid)\n\n\n        //update grid\n        grid.collectionChange(false);\n\n\n      }\n\n\n    });\n    this.subscriptionsArray = arrayObserver\n  }\n\n\n  /***************************************************************************************\n   * enable attributes abservables, ->vGridCollection.name etc\n   ***************************************************************************************/\n  enableObservablesAttributes() {\n    this.vGrid.vGridConfig.attAttributeObserve.forEach((property) => {\n      let propertyObserver = this.bindingEngine.propertyObserver(this.vGrid.vGridCurrentEntity, property).subscribe((newValue, oldValue) => {\n\n        //should I do the value formatting on the currentEntity also?\n        var newValueCheck = (newValue !== undefined && newValue !== null) ? newValue.toString() : newValue;\n        var oldValueCheck = (oldValue !== undefined && oldValue !== null) ? oldValue.toString() : oldValue;\n\n        if (newValueCheck !== oldValueCheck && this.vGrid.vGridCurrentEntityRef) {\n              this.vGrid.vGridCurrentEntityRef[property] = newValue;\n              this.vGrid.vGridGenerator.rebindRowNumber(this.vGrid.vGridCurrentRow);\n        }\n      });\n      this.subscriptionsAttributes.push(propertyObserver)\n    });\n  }\n\n\n  /***************************************************************************************\n   *  disable vGridCollection observables\n   ***************************************************************************************/\n  disableObservablesCollection() {\n    this.collectionSubscription.unsubscribe(this.vGrid, this.collectioncallable);\n    //this.collectionSubscription = null;\n  }\n\n\n  /***************************************************************************************\n   * disable the array observables\n   ***************************************************************************************/\n  disableObservablesArray() {\n    this.subscriptionsArray.dispose();\n    this.subscriptionsArray = null;\n  }\n\n\n  /***************************************************************************************\n   * disable the attibutes observables\n   ***************************************************************************************/\n  disableObservablesAttributes() {\n    for (var i = 0; i < this.subscriptionsAttributes.length; i++) {\n      try {\n        this.subscriptionsAttributes[i].dispose()\n      } catch (e) {\n      }\n    }\n    this.subscriptionsAttributes = [];\n  }\n\n\n}\n"]}